name: Build iOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual run

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.1' # Specify your Flutter version; adjust as needed
        channel: 'stable'

    - name: Cache Flutter Pub
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: ${{ runner.os }}-pub-cache-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-cache-

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: List project files (for debugging)
      run: |
        echo "=== Project Structure ==="
        find . -name "*.xcodeproj" -o -name "*.xcworkspace" | head -10

    - name: Get Flutter dependencies
      run: |
        flutter pub get

    - name: Install CocoaPods and Update Podfile
      run: |
        if [ -f "ios/Podfile" ]; then
          echo "Updating Podfile with minimum iOS version 13.0..."
          # Backup original Podfile
          cp ios/Podfile ios/Podfile.backup
          # Insert platform directive at the top (handle existing content)
          if ! grep -q "platform :ios" ios/Podfile; then
            sed -i '' '1s/^/platform :ios, "13.0"\n/' ios/Podfile
          else
            sed -i '' 's/platform :ios,/platform :ios, "13.0"/g' ios/Podfile
          fi
          # Verify the change
          if ! grep -q "platform :ios, \"13.0\"" ios/Podfile; then
            echo "Failed to update Podfile with platform iOS 13.0!"
            exit 1
          fi
          # Install CocoaPods
          sudo gem install cocoapods
          pod install --project-directory=ios
        fi

    - name: Install All Simulator Runtimes
      run: |
        echo "Attempting to download all simulator runtimes..."
        sudo xcodebuild -downloadAllPlatforms
        # Wait for runtimes to be available (up to 10 minutes)
        for i in {1..60}; do
          if xcrun simctl list | grep -q "iOS"; then
            echo "Simulator runtimes detected."
            break
          fi
          echo "Waiting for simulator runtimes... ($i/60)"
          sleep 10
          if [ $i -eq 60 ]; then
            echo "Timeout: No simulator runtimes detected. Check with 'xcrun simctl list'."
            exit 1
          fi
        done

    - name: List Available SDKs (Debug)
      run: |
        xcodebuild -showsdks

    - name: Build Flutter iOS
      run: |
        flutter build ios --simulator --no-codesign

    - name: Copy .app for Upload
      run: |
        APP_PATH="build/ios/iphonesimulator/Runner.app"
        if [ -d "$APP_PATH" ]; then
          echo "Found app at: $APP_PATH"
          cp -r "$APP_PATH" "./Runner.app"
          echo "Copied to: ./Runner.app"
        else
          echo "No .app file found at $APP_PATH!"
          exit 1
        fi

    - name: Upload App
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App-Simulator-${{ github.sha }}
        path: "Runner.app"
        retention-days: 30